<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='éšç€é¡¹ç›®çš„ä¸æ–­å¢å¤šï¼Œæœ€å¼€å§‹å•ä½“é¡¹ç›®æ‰‹åŠ¨æ‰§è¡Œ docker build å‘½ä»¤ï¼Œæ‰‹åŠ¨å‘å¸ƒé¡¹ç›®å°±ä¸å†é€‚ç”¨äº†ã€‚ä¸€ä¸¤ä¸ªé¡¹ç›®å¯èƒ½è¿˜åƒå¾—æ¶ˆï¼Œ10 å¤šä¸ªé¡¹ç›®æ¯å¤©è®©ä½ æ„å»ºä¸€æ¬¡è¿˜æ˜¯å¤Ÿå‘›ã€‚å³ä¾¿ä½ çš„é¡¹ç›®å°‘ï¼Œæ¯æ¬¡èŠ±è´¹åœ¨å‘å¸ƒä¸Šé¢çš„æ—¶é—´ç´¯è®¡èµ·æ¥éƒ½å¤Ÿä½ æ”¹å‡ ä¸ª BUG äº†ã€‚
æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªåŠ¨åŒ–è¿™ä¸ªæµç¨‹ï¼Œè®©é¡¹ç›®çš„å‘å¸ƒå’Œæµ‹è¯•ä¸å†è¿™ä¹ˆç¹çã€‚åœ¨è¿™é‡Œæˆ‘ä½¿ç”¨äº† Jenkins ä½œä¸ºåŸºç¡€çš„ CI/CD Pipeline å·¥å…·ï¼Œå…³äº Jenkins çš„å…·ä½“ä»‹ç»è¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚åœ¨ç‰ˆæœ¬ç®¡ç†ã€æ„å»ºé¡¹ç›®ã€å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç¯å¢ƒéƒ¨ç½²æˆ‘åˆ†åˆ«ä½¿ç”¨åˆ°äº† Gogsã€Dockerã€Docker Swarm(å·²ä¸ Docker æ•´åˆ) è¿™å‡ ä¸ªè½¯ä»¶ååŒå·¥ä½œã€‚
ä»¥ä¸‹æ­¥éª¤æˆ‘å‚è€ƒäº† Continuous Integration with Jenkins and Docker ä¸€æ–‡ï¼Œå¹¶ä½¿ç”¨äº†ä½œè€…æä¾›çš„ groovy æ–‡ä»¶å’Œ slave.py æ–‡ä»¶ã€‚
å…³äº Docker-CE çš„å®‰è£…ï¼Œè¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡åšæ–‡ ã€ŠLinux ä¸‹çš„ Docker å®‰è£…ä¸ä½¿ç”¨ã€‹ ã€‚
'><title>Jenkins ç»“åˆ Docker å®ç°ä½é…ç‰ˆçš„ CI&amp;CD</title>

<link rel='canonical' href='https://real-zony.github.io/p/jenkins-combines-docker-to-implement-low-level-ci/'>

<link rel="stylesheet" href="/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css"><meta property='og:title' content='Jenkins ç»“åˆ Docker å®ç°ä½é…ç‰ˆçš„ CI&amp;CD'>
<meta property='og:description' content='éšç€é¡¹ç›®çš„ä¸æ–­å¢å¤šï¼Œæœ€å¼€å§‹å•ä½“é¡¹ç›®æ‰‹åŠ¨æ‰§è¡Œ docker build å‘½ä»¤ï¼Œæ‰‹åŠ¨å‘å¸ƒé¡¹ç›®å°±ä¸å†é€‚ç”¨äº†ã€‚ä¸€ä¸¤ä¸ªé¡¹ç›®å¯èƒ½è¿˜åƒå¾—æ¶ˆï¼Œ10 å¤šä¸ªé¡¹ç›®æ¯å¤©è®©ä½ æ„å»ºä¸€æ¬¡è¿˜æ˜¯å¤Ÿå‘›ã€‚å³ä¾¿ä½ çš„é¡¹ç›®å°‘ï¼Œæ¯æ¬¡èŠ±è´¹åœ¨å‘å¸ƒä¸Šé¢çš„æ—¶é—´ç´¯è®¡èµ·æ¥éƒ½å¤Ÿä½ æ”¹å‡ ä¸ª BUG äº†ã€‚
æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªåŠ¨åŒ–è¿™ä¸ªæµç¨‹ï¼Œè®©é¡¹ç›®çš„å‘å¸ƒå’Œæµ‹è¯•ä¸å†è¿™ä¹ˆç¹çã€‚åœ¨è¿™é‡Œæˆ‘ä½¿ç”¨äº† Jenkins ä½œä¸ºåŸºç¡€çš„ CI/CD Pipeline å·¥å…·ï¼Œå…³äº Jenkins çš„å…·ä½“ä»‹ç»è¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚åœ¨ç‰ˆæœ¬ç®¡ç†ã€æ„å»ºé¡¹ç›®ã€å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç¯å¢ƒéƒ¨ç½²æˆ‘åˆ†åˆ«ä½¿ç”¨åˆ°äº† Gogsã€Dockerã€Docker Swarm(å·²ä¸ Docker æ•´åˆ) è¿™å‡ ä¸ªè½¯ä»¶ååŒå·¥ä½œã€‚
ä»¥ä¸‹æ­¥éª¤æˆ‘å‚è€ƒäº† Continuous Integration with Jenkins and Docker ä¸€æ–‡ï¼Œå¹¶ä½¿ç”¨äº†ä½œè€…æä¾›çš„ groovy æ–‡ä»¶å’Œ slave.py æ–‡ä»¶ã€‚
å…³äº Docker-CE çš„å®‰è£…ï¼Œè¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡åšæ–‡ ã€ŠLinux ä¸‹çš„ Docker å®‰è£…ä¸ä½¿ç”¨ã€‹ ã€‚
'>
<meta property='og:url' content='https://real-zony.github.io/p/jenkins-combines-docker-to-implement-low-level-ci/'>
<meta property='og:site_name' content='Zony çš„åšå®¢'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Jenkins' /><meta property='article:tag' content='Docker' /><meta property='article:tag' content='CI/CD' /><meta property='article:tag' content='Docker Compose' /><meta property='article:tag' content='DevOps' /><meta property='article:tag' content='Linux' /><meta property='article:published_time' content='2019-09-25T04:42:11&#43;00:00'/><meta property='article:modified_time' content='2019-09-25T04:42:11&#43;00:00'/>
<meta name="twitter:title" content="Jenkins ç»“åˆ Docker å®ç°ä½é…ç‰ˆçš„ CI&amp;CD">
<meta name="twitter:description" content="éšç€é¡¹ç›®çš„ä¸æ–­å¢å¤šï¼Œæœ€å¼€å§‹å•ä½“é¡¹ç›®æ‰‹åŠ¨æ‰§è¡Œ docker build å‘½ä»¤ï¼Œæ‰‹åŠ¨å‘å¸ƒé¡¹ç›®å°±ä¸å†é€‚ç”¨äº†ã€‚ä¸€ä¸¤ä¸ªé¡¹ç›®å¯èƒ½è¿˜åƒå¾—æ¶ˆï¼Œ10 å¤šä¸ªé¡¹ç›®æ¯å¤©è®©ä½ æ„å»ºä¸€æ¬¡è¿˜æ˜¯å¤Ÿå‘›ã€‚å³ä¾¿ä½ çš„é¡¹ç›®å°‘ï¼Œæ¯æ¬¡èŠ±è´¹åœ¨å‘å¸ƒä¸Šé¢çš„æ—¶é—´ç´¯è®¡èµ·æ¥éƒ½å¤Ÿä½ æ”¹å‡ ä¸ª BUG äº†ã€‚
æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªåŠ¨åŒ–è¿™ä¸ªæµç¨‹ï¼Œè®©é¡¹ç›®çš„å‘å¸ƒå’Œæµ‹è¯•ä¸å†è¿™ä¹ˆç¹çã€‚åœ¨è¿™é‡Œæˆ‘ä½¿ç”¨äº† Jenkins ä½œä¸ºåŸºç¡€çš„ CI/CD Pipeline å·¥å…·ï¼Œå…³äº Jenkins çš„å…·ä½“ä»‹ç»è¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚åœ¨ç‰ˆæœ¬ç®¡ç†ã€æ„å»ºé¡¹ç›®ã€å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç¯å¢ƒéƒ¨ç½²æˆ‘åˆ†åˆ«ä½¿ç”¨åˆ°äº† Gogsã€Dockerã€Docker Swarm(å·²ä¸ Docker æ•´åˆ) è¿™å‡ ä¸ªè½¯ä»¶ååŒå·¥ä½œã€‚
ä»¥ä¸‹æ­¥éª¤æˆ‘å‚è€ƒäº† Continuous Integration with Jenkins and Docker ä¸€æ–‡ï¼Œå¹¶ä½¿ç”¨äº†ä½œè€…æä¾›çš„ groovy æ–‡ä»¶å’Œ slave.py æ–‡ä»¶ã€‚
å…³äº Docker-CE çš„å®‰è£…ï¼Œè¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡åšæ–‡ ã€ŠLinux ä¸‹çš„ Docker å®‰è£…ä¸ä½¿ç”¨ã€‹ ã€‚
">
  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu88ff3bfa88d8ce73b9d64b435a0a3f2c_26917_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Zony çš„åšå®¢</a></h1>
            <h2 class="site-description">A .NET Developer</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/real-zony'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        

        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å­˜æ¡£</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        

        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://real-zony.github.io/en/" >English</option>
                        
                            <option value="https://real-zony.github.io/" selected>ä¸­æ–‡</option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/jenkins-combines-docker-to-implement-low-level-ci/">Jenkins ç»“åˆ Docker å®ç°ä½é…ç‰ˆçš„ CI&amp;CD</a>
        </h2>
    
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 25, 2019</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 7 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <p>éšç€é¡¹ç›®çš„ä¸æ–­å¢å¤šï¼Œæœ€å¼€å§‹å•ä½“é¡¹ç›®æ‰‹åŠ¨æ‰§è¡Œ <code>docker build</code> å‘½ä»¤ï¼Œæ‰‹åŠ¨å‘å¸ƒé¡¹ç›®å°±ä¸å†é€‚ç”¨äº†ã€‚ä¸€ä¸¤ä¸ªé¡¹ç›®å¯èƒ½è¿˜åƒå¾—æ¶ˆï¼Œ10 å¤šä¸ªé¡¹ç›®æ¯å¤©è®©ä½ æ„å»ºä¸€æ¬¡è¿˜æ˜¯å¤Ÿå‘›ã€‚å³ä¾¿ä½ çš„é¡¹ç›®å°‘ï¼Œæ¯æ¬¡èŠ±è´¹åœ¨å‘å¸ƒä¸Šé¢çš„æ—¶é—´ç´¯è®¡èµ·æ¥éƒ½å¤Ÿä½ æ”¹å‡ ä¸ª BUG äº†ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªåŠ¨åŒ–è¿™ä¸ªæµç¨‹ï¼Œè®©é¡¹ç›®çš„å‘å¸ƒå’Œæµ‹è¯•ä¸å†è¿™ä¹ˆç¹çã€‚åœ¨è¿™é‡Œæˆ‘ä½¿ç”¨äº† Jenkins ä½œä¸ºåŸºç¡€çš„ CI/CD Pipeline å·¥å…·ï¼Œå…³äº Jenkins çš„å…·ä½“ä»‹ç»è¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚åœ¨ç‰ˆæœ¬ç®¡ç†ã€æ„å»ºé¡¹ç›®ã€å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç¯å¢ƒéƒ¨ç½²æˆ‘åˆ†åˆ«ä½¿ç”¨åˆ°äº† <strong>Gogs</strong>ã€<strong>Docker</strong>ã€<strong>Docker Swarm(å·²ä¸ Docker æ•´åˆ)</strong> è¿™å‡ ä¸ªè½¯ä»¶ååŒå·¥ä½œã€‚</p>
<p>ä»¥ä¸‹æ­¥éª¤æˆ‘å‚è€ƒäº† <strong><a class="link" href="https://code-maze.com/ci-jenkins-docker/#comments"  target="_blank" rel="noopener"
    >Continuous Integration with Jenkins and Docker</a></strong> ä¸€æ–‡ï¼Œå¹¶ä½¿ç”¨äº†ä½œè€…æä¾›çš„ groovy æ–‡ä»¶å’Œ <code>slave.py</code> æ–‡ä»¶ã€‚</p>
<p>å…³äº <strong>Docker-CE</strong> çš„å®‰è£…ï¼Œè¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡åšæ–‡ <a class="link" href="https://www.cnblogs.com/myzony/p/9071210.html"  target="_blank" rel="noopener"
    >ã€ŠLinux ä¸‹çš„ Docker å®‰è£…ä¸ä½¿ç”¨ã€‹</a> ã€‚</p>
<h2 id="ä¸€jenkins-çš„éƒ¨ç½²">ä¸€ã€Jenkins çš„éƒ¨ç½²</h2>
<p>æ—¢ç„¶éƒ½ç”¨äº† Dockerï¼Œæˆ‘æ˜¯ä¸æƒ³åœ¨å®ä½“æœºä¸Šé¢å®‰è£…ä¸€å †ç¯å¢ƒï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨äº† Docker çš„å½¢å¼æ¥éƒ¨ç½² Jenkins çš„ Master å’Œ Slaveï¼Œçœæ—¶çœåŠ›ã€‚Master å°±æ˜¯è°ƒåº¦ç®¡é“ä»»åŠ¡çš„ä¸»æœºï¼Œä¹Ÿæ˜¯å”¯ä¸€æœ‰ UI ä¾›ç”¨æˆ·æ“ä½œçš„ã€‚è€Œ Slave å°±æ˜¯å…·ä½“çš„å·¥ä½œèŠ‚ç‚¹ï¼Œç”¨äºæ‰§è¡Œå…·ä½“çš„ç®¡é“ä»»åŠ¡ã€‚</p>
<h3 id="11-æ„å»º-master-é•œåƒ">1.1 æ„å»º Master é•œåƒ</h3>
<p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨ä¸»æœºä¸Šå»ºç«‹ä¸€ä¸ª master æ–‡ä»¶å¤¹ï¼Œå¹¶ä½¿ç”¨ <code>vi </code>åˆ›å»ºä¸¤ä¸ª groovy æ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶åœ¨åé¢çš„ Dockerfile ä¼šè¢«ä½¿ç”¨åˆ°ï¼Œä¸‹é¢æ˜¯ <code>default-user.groovy</code> æ–‡ä»¶çš„ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-groovy" data-lang="groovy"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jenkins.model.*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hudson.security.*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">def</span> <span class="n">env</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">def</span> <span class="n">jenkins</span> <span class="o">=</span> <span class="n">Jenkins</span><span class="o">.</span><span class="na">getInstance</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="n">jenkins</span><span class="o">.</span><span class="na">setSecurityRealm</span><span class="o">(</span><span class="k">new</span> <span class="n">HudsonPrivateSecurityRealm</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="n">jenkins</span><span class="o">.</span><span class="na">setAuthorizationStrategy</span><span class="o">(</span><span class="k">new</span> <span class="n">GlobalMatrixAuthorizationStrategy</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">def</span> <span class="n">user</span> <span class="o">=</span> <span class="n">jenkins</span><span class="o">.</span><span class="na">getSecurityRealm</span><span class="o">().</span><span class="na">createAccount</span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">JENKINS_USER</span><span class="o">,</span> <span class="n">env</span><span class="o">.</span><span class="na">JENKINS_PASS</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">user</span><span class="o">.</span><span class="na">save</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">jenkins</span><span class="o">.</span><span class="na">getAuthorizationStrategy</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">Jenkins</span><span class="o">.</span><span class="na">ADMINISTER</span><span class="o">,</span> <span class="n">env</span><span class="o">.</span><span class="na">JENKINS_USER</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">jenkins</span><span class="o">.</span><span class="na">save</span><span class="o">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥ç€å†ç”¨ <code>vi</code> åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>executors.groovy</code> æ–‡ä»¶ï¼Œå¹¶è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-groovy" data-lang="groovy"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jenkins.model.*</span>
</span></span><span class="line"><span class="cl"><span class="n">Jenkins</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">setNumExecutors</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥ä¸ŠåŠ¨ä½œå®Œæˆä¹‹åï¼Œåœ¨ master æ–‡ä»¶å¤¹ä¸‹é¢åº”è¯¥æœ‰ä¸¤ä¸ª groovy æ–‡ä»¶ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569304766695.png"
	width="1187"
	height="122"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569304766695_hu610ff5b4b3e945607ef9c8b934cff5f1_30298_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569304766695_hu610ff5b4b3e945607ef9c8b934cff5f1_30298_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569304766695"
	
	
		class="gallery-image" 
		data-flex-grow="972"
		data-flex-basis="2335px"
	
></p>
<p>ä¸¤ä¸ª master æ‰€éœ€è¦çš„ groovy æ–‡ä»¶å·²ç»ç¼–å†™å®Œæˆï¼Œä¸‹é¢æ¥ç¼–å†™ master é•œåƒçš„ Dockerfile æ–‡ä»¶ï¼Œæ¯ä¸€æ­¥çš„ä½œç”¨æˆ‘å·²ç»ç”¨ä¸­æ–‡è¿›è¡Œäº†æ ‡æ³¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># ä½¿ç”¨å®˜æ–¹çš„ Jenkins é•œåƒä½œä¸ºåŸºç¡€é•œåƒã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> jenkins/jenkins:latest</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># ä½¿ç”¨å†…ç½®çš„ install-plugins.sh æ¥å®‰è£…æ’ä»¶ã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> /usr/local/bin/install-plugins.sh git matrix-auth workflow-aggregator docker-workflow blueocean credentials-binding<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># è®¾ç½® Jenkins çš„ç®¡ç†å‘˜è´¦æˆ·å’Œå¯†ç ã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> JENKINS_USER admin<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> JENKINS_PASS admin<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># è·³è¿‡åˆå§‹åŒ–å®‰è£…å‘å¯¼ã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> JAVA_OPTS -Djenkins.install.runSetupWizard<span class="o">=</span>false<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># å°†åˆšåˆšç¼–å†™çš„ä¸¤ä¸ª groovy è„šæœ¬å¤åˆ¶åˆ°åˆå§‹åŒ–æ–‡ä»¶å¤¹å†…ã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> executors.groovy /usr/share/jenkins/ref/init.groovy.d/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> default-user.groovy /usr/share/jenkins/ref/init.groovy.d/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># æŒ‚è½½ jenkins_home ç›®å½•åˆ° Docker å·ã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">VOLUME</span><span class="s"> /var/jenkins_home</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥ç€æˆ‘ä»¬é€šè¿‡å‘½ä»¤æ„å»ºå‡º Master é•œåƒã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker build -t jenkins-master .
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569310062770.png"
	width="1687"
	height="710"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569310062770_hua4416823c569a0be8dd13b651cc3078f_195504_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569310062770_hua4416823c569a0be8dd13b651cc3078f_195504_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569310062770"
	
	
		class="gallery-image" 
		data-flex-grow="237"
		data-flex-basis="570px"
	
></p>
<h3 id="12-æ„å»º-slave-é•œåƒ">1.2 æ„å»º Slave é•œåƒ</h3>
<p>Slave é•œåƒçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ª <code>slave.py</code> çš„ python è„šæœ¬ï¼Œå®ƒä¸»è¦æ‰§è¡Œçš„åŠ¨ä½œæ˜¯è¿è¡Œ <code>slave.jar</code> å¹¶å’Œ Master å»ºç«‹é€šä¿¡ï¼Œè¿™æ ·ä½ çš„ç®¡é“ä»»åŠ¡å°±èƒ½å¤Ÿäº¤ç»™ Slave è¿›è¡Œæ‰§è¡Œã€‚è¿™ä¸ªè„šæœ¬æ‰€åšçš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">st=&gt;start: è„šæœ¬æ‰§è¡Œ
</span></span><span class="line"><span class="cl">stop=&gt;end: å®¹å™¨åœæ­¢
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">op1=&gt;operation: å¯¼å…¥ &#34;jenkins&#34; çš„ python æ¨¡å—
</span></span><span class="line"><span class="cl">op2=&gt;operation: ç­‰å¾… Master å¯åŠ¨
</span></span><span class="line"><span class="cl">cond1=&gt;condition: Master æ˜¯å¦å¯ç”¨
</span></span><span class="line"><span class="cl">op3=&gt;operation: ä¸‹è½½ slave.jar æ–‡ä»¶åˆ°å®¹å™¨å†…
</span></span><span class="line"><span class="cl">op4=&gt;operation: é€šè¿‡ JLNP è¿æ¥åˆ° Master èŠ‚ç‚¹
</span></span><span class="line"><span class="cl">op5=&gt;operation: ä½¿ç”¨å‡­æ®é€šè¿‡æˆæƒéªŒè¯
</span></span><span class="line"><span class="cl">op6=&gt;operation: æˆåŠŸè¿è¡Œ Slave
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">st-&gt;op1-&gt;op2-&gt;cond1
</span></span><span class="line"><span class="cl">cond1(no)-&gt;op2
</span></span><span class="line"><span class="cl">cond1(yes)-&gt;op3-&gt;op4-&gt;op5-&gt;op6-&gt;stop
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬å†å»ºç«‹ä¸€ä¸ª slave æ–‡ä»¶å¤¹ï¼Œå¹¶ä½¿ç”¨ <code>vi</code> å°† python è„šæœ¬å¤åˆ¶è¿›å»ã€‚</p>
<p><code>slave.py</code> çš„å†…å®¹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">jenkins</span> <span class="kn">import</span> <span class="n">Jenkins</span><span class="p">,</span> <span class="n">JenkinsError</span><span class="p">,</span> <span class="n">NodeLaunchMethod</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">signal</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">urllib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">shutil</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">slave_jar</span> <span class="o">=</span> <span class="s1">&#39;/var/lib/jenkins/slave.jar&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">slave_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLAVE_NAME&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLAVE_NAME&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;docker-slave-&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOSTNAME&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">jnlp_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_URL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/computer/&#39;</span> <span class="o">+</span> <span class="n">slave_name</span> <span class="o">+</span> <span class="s1">&#39;/slave-agent.jnlp&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">slave_jar_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_URL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/jnlpJars/slave.jar&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">slave_jar_url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">process</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">clean_dir</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">slave_create</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">,</span> <span class="n">executors</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">j</span> <span class="o">=</span> <span class="n">Jenkins</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_URL&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_USER&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_PASS&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">j</span><span class="o">.</span><span class="n">node_create</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">,</span> <span class="n">num_executors</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">executors</span><span class="p">),</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">,</span> <span class="n">launcher</span> <span class="o">=</span> <span class="n">NodeLaunchMethod</span><span class="o">.</span><span class="n">JNLP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">slave_delete</span><span class="p">(</span><span class="n">node_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">j</span> <span class="o">=</span> <span class="n">Jenkins</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_URL&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_USER&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_PASS&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">j</span><span class="o">.</span><span class="n">node_delete</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">slave_download</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">slave_jar</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">slave_jar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">loader</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">URLopener</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">loader</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_URL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/jnlpJars/slave.jar&#39;</span><span class="p">,</span> <span class="s1">&#39;/var/lib/jenkins/slave.jar&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">slave_run</span><span class="p">(</span><span class="n">slave_jar</span><span class="p">,</span> <span class="n">jnlp_url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;java&#39;</span><span class="p">,</span> <span class="s1">&#39;-jar&#39;</span><span class="p">,</span> <span class="n">slave_jar</span><span class="p">,</span> <span class="s1">&#39;-jnlpUrl&#39;</span><span class="p">,</span> <span class="n">jnlp_url</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_SLAVE_ADDRESS&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span> <span class="s1">&#39;-connectTo&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_SLAVE_ADDRESS&#39;</span> <span class="p">]</span> <span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLAVE_SECRET&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span> <span class="s1">&#39;-jnlpCredentials&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_USER&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;JENKINS_PASS&#39;</span><span class="p">]</span> <span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span> <span class="s1">&#39;-secret&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLAVE_SECRET&#39;</span><span class="p">]</span> <span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">process</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">process</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">master_ready</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="ow">not</span> <span class="n">master_ready</span><span class="p">(</span><span class="n">slave_jar_url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Master not ready yet, sleeping for 10sec!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">slave_download</span><span class="p">(</span><span class="n">slave_jar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span> <span class="s1">&#39;Downloaded Jenkins slave jar.&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLAVE_WORING_DIR&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">setcwd</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLAVE_WORING_DIR&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CLEAN_WORKING_DIR&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">clean_dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span> <span class="s2">&#34;Cleaned up working directory.&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLAVE_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">slave_create</span><span class="p">(</span><span class="n">slave_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLAVE_EXECUTORS&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLAVE_LABELS&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span> <span class="s1">&#39;Created temporary Jenkins slave.&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">process</span> <span class="o">=</span> <span class="n">slave_run</span><span class="p">(</span><span class="n">slave_jar</span><span class="p">,</span> <span class="n">jnlp_url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span> <span class="s1">&#39;Started Jenkins slave with name &#34;&#39;</span> <span class="o">+</span> <span class="n">slave_name</span> <span class="o">+</span> <span class="s1">&#39;&#34; and labels [&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLAVE_LABELS&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;].&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span> <span class="s1">&#39;Jenkins slave stopped.&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SLAVE_NAME&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">slave_delete</span><span class="p">(</span><span class="n">slave_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span> <span class="s1">&#39;Removed temporary Jenkins slave.&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°è„šæœ¬çš„å·¥ä½œåŸºæœ¬ä¸æµç¨‹å›¾çš„ä¸€è‡´ï¼Œå› ä¸º Jenkins é’ˆå¯¹ Python æä¾›äº† SDK ï¼Œæ‰€ä»¥åŸä½œè€…ä½¿ç”¨ Python æ¥ç¼–å†™çš„ â€œä»£ç†â€ ç¨‹åºã€‚ä¸è¿‡ Jenkins ä¹Ÿæœ‰ RESTful APIï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ .NET Core ç¼–å†™ç±»ä¼¼çš„ â€œä»£ç†â€ ç¨‹åºã€‚</p>
<p>æ¥ç€æˆ‘ä»¬æ¥ç¼–å†™ Slave é•œåƒçš„ Dockerfile æ–‡ä»¶ï¼Œå› ä¸ºå›½å†…æœåŠ¡å™¨è®¿é—® Ubuntu çš„æºå¾ˆæ…¢ï¼Œç»å¸¸å› ä¸ºè¶…æ—¶å¯¼è‡´æ„å»ºå¤±è´¥ï¼Œè¿™é‡Œåˆ‡æ¢æˆäº†é˜¿é‡Œäº‘çš„æºï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> ubuntu:16.04</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># å®‰è£… Docker CLIã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list <span class="o">&amp;&amp;</span> apt-get clean<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt-get update --fix-missing <span class="o">&amp;&amp;</span> apt-get install -y apt-transport-https ca-certificates curl openjdk-8-jre python python-pip git<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># ä½¿ç”¨é˜¿é‡Œäº‘çš„é•œåƒæºã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="p">|</span> apt-key add -<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nb">echo</span> <span class="s2">&#34;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial stable&#34;</span> &gt; /etc/apt/sources.list.d/docker.list<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt-get update --fix-missing <span class="o">&amp;&amp;</span> apt-get install -y docker-ce --allow-unauthenticated<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> easy_install jenkins-webapi<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># å®‰è£… Docker-Compose å·¥å…·ã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-<span class="sb">`</span>uname -s<span class="sb">`</span>-<span class="sb">`</span>uname -m<span class="sb">`</span> &gt; /usr/local/bin/docker-compose <span class="o">&amp;&amp;</span> chmod +x /usr/local/bin/docker-compose<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> mkdir -p /home/jenkins<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> mkdir -p /var/lib/jenkins<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># å°† slave.py æ–‡ä»¶æ·»åŠ åˆ°å®¹å™¨ã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ADD</span> slave.py /var/lib/jenkins/slave.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /home/jenkins</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># é…ç½® Jenkins Master çš„ä¸€äº›è¿æ¥å‚æ•°å’Œ Slave ä¿¡æ¯ã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> JENKINS_URL <span class="s2">&#34;http://jenkins&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> JENKINS_SLAVE_ADDRESS <span class="s2">&#34;&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> JENKINS_USER <span class="s2">&#34;admin&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> JENKINS_PASS <span class="s2">&#34;admin&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> SLAVE_NAME <span class="s2">&#34;&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> SLAVE_SECRET <span class="s2">&#34;&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> SLAVE_EXECUTORS <span class="s2">&#34;1&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> SLAVE_LABELS <span class="s2">&#34;docker&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> SLAVE_WORING_DIR <span class="s2">&#34;&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> CLEAN_WORKING_DIR <span class="s2">&#34;true&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span> <span class="s2">&#34;python&#34;</span><span class="p">,</span> <span class="s2">&#34;-u&#34;</span><span class="p">,</span> <span class="s2">&#34;/var/lib/jenkins/slave.py&#34;</span> <span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ç»§ç»­ä½¿ç”¨ <code>docker build</code> æ„å»º Slave é•œåƒï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">docker build -t jenkins-slave .
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="13-ç¼–å†™-docker-compose-æ–‡ä»¶">1.3 ç¼–å†™ Docker Compose æ–‡ä»¶</h3>
<p>è¿™é‡Œçš„ Docker Compose æ–‡ä»¶ï¼Œæˆ‘å–åå« <code>docker-compose.jenkins.yaml</code> ï¼Œä¸»è¦å·¥ä½œæ˜¯ä¸ºäº†å¯åŠ¨ Master å’Œ Slave å®¹å™¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">jenkins</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">jenkins</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s1">&#39;8080:8080&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s1">&#39;50000:50000&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">jenkins-master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">jenkins-slave</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">jenkins-slave</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s1">&#39;JENKINS_URL=http://jenkins:8080&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">jenkins-slave</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">/var/run/docker.sock:/var/run/docker.sock </span><span class="w"> </span><span class="c"># å°†å®¿ä¸»æœºçš„ Docker Daemon æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">/home/jenkins:/home/jenkins</span><span class="w"> </span><span class="c"># å°†æ•°æ®æŒ‚è½½å‡ºæ¥ï¼Œæ–¹ä¾¿åç»­è¿›è¡Œé‡Šæ”¾ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">jenkins</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œ Docker Compose ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡ <code>å®¿ä¸»æœº IP:8080</code> å°±å¯ä»¥è®¿é—®åˆ° Jenkins å†…éƒ¨äº†ï¼Œå¦‚ä¸‹å›¾ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569317919395.png"
	width="3840"
	height="1877"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569317919395_huf468a4d59467a253cefa6dcd361e50c2_80151_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569317919395_huf468a4d59467a253cefa6dcd361e50c2_80151_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569317919395"
	
	
		class="gallery-image" 
		data-flex-grow="204"
		data-flex-basis="490px"
	
></p>
<h2 id="äºŒgogs-çš„éƒ¨ç½²">äºŒã€Gogs çš„éƒ¨ç½²</h2>
<p>æˆ‘ä»¬å†…éƒ¨å¼€å‘ä½¿ç”¨çš„ Git ä»“åº“æ˜¯ä½¿ç”¨ Gogs è¿›è¡Œæ­å»ºçš„ï¼ŒGogs å®˜æ–¹æä¾›äº† Docker é•œåƒï¼Œé‚£æˆ‘ä»¬å¯ä»¥ç›´æ¥ç¼–å†™ä¸€ä¸ª Docker Compose å¿«é€Ÿéƒ¨ç½² Gogsã€‚</p>
<p><code>docker-compose.gogs.yaml</code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">gogs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gogs/gogs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gogs&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s1">&#39;3000:3000&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="m">22</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">/var/lib/docker/Persistence/Gogs:/data	# æŒ‚è½½æ•°æ®å·ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åï¼Œå³å¯å¯åŠ¨ Gogs ç¨‹åºï¼Œè®¿é—® <code>å®¿ä¸»æœº IP:3000</code> æŒ‰ç…§é…ç½®è¯´æ˜å®‰è£… Gogs å³å¯ï¼Œä¹‹åä½ å°±å¯ä»¥åˆ›å»ºè¿œç¨‹ä»“åº“äº†ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569309071060.png"
	width="2482"
	height="1591"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569309071060_hu0fdd500473f20cf8c47d71376dbeba69_248403_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569309071060_hu0fdd500473f20cf8c47d71376dbeba69_248403_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569309071060"
	
	
		class="gallery-image" 
		data-flex-grow="156"
		data-flex-basis="374px"
	
></p>
<h2 id="ä¸‰gogs-ä¸-jenkins-çš„é›†æˆ">ä¸‰ã€Gogs ä¸ Jenkins çš„é›†æˆ</h2>
<p>è™½ç„¶å¤§éƒ¨åˆ†éƒ½æ¨è Jenkins çš„ Gogs Webhook æ’ä»¶ï¼Œä¸è¿‡è¿™ä¸ªæ’ä»¶å¾ˆä¹…ä¸æ›´æ–°äº†ï¼Œè€Œä¸”ä¸æ”¯æŒ <strong>ç‰ˆæœ¬å‘å¸ƒ</strong> äº‹ä»¶ã€‚é’ˆå¯¹äºè¯¥é—®é¢˜è™½ç„¶å®˜æ–¹æœ‰ <a class="link" href="https://github.com/jenkinsci/gogs-webhook-plugin/pull/62"  target="_blank" rel="noopener"
    >PR #62</a>ï¼Œä½†ä¸€ç›´æ²¡æœ‰åˆå¹¶ï¼Œç­‰åˆ°åˆå¹¶çš„æ—¶å€™éƒ½æ˜¯çŒ´å¹´é©¬æœˆäº†ã€‚è¿™é‡Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨ <strong>Generic Webhook Trigger</strong> ï¼Œç”¨è¿™ä¸ªæ’ä»¶æ¥è§¦å‘ Jenkins çš„ç®¡é“ä»»åŠ¡ã€‚</p>
<h3 id="31-åˆ›å»ºæµæ°´çº¿é¡¹ç›®">3.1 åˆ›å»ºæµæ°´çº¿é¡¹ç›®</h3>
<p>é¦–å…ˆæ‰¾åˆ° Jenkins çš„æ’ä»¶ä¸­å¿ƒï¼Œæœç´¢ Generic Webhook Trigger æ’ä»¶ï¼Œå¹¶è¿›è¡Œå®‰è£…ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/20190924210101.gif"
	width="1920"
	height="882"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/20190924210101_hud4323201595f837ed2c008c2975e63cc_1360368_480x0_resize_box_1.gif 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/20190924210101_hud4323201595f837ed2c008c2975e63cc_1360368_1024x0_resize_box_1.gif 1024w"
	loading="lazy"
	
		alt="20190924210101"
	
	
		class="gallery-image" 
		data-flex-grow="217"
		data-flex-basis="522px"
	
></p>
<p>ç»§ç»­æ–°å»ºä¸€ä¸ªç®¡é“ä»»åŠ¡ï¼Œå–åå«åš TestProjectï¼Œç±»å‹é€‰æ‹© Pipeline ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/20190924210701.gif"
	width="1920"
	height="623"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/20190924210701_hu3435afd9011b083822ed8b3e00d1574a_284015_480x0_resize_box_1.gif 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/20190924210701_hu3435afd9011b083822ed8b3e00d1574a_284015_1024x0_resize_box_1.gif 1024w"
	loading="lazy"
	
		alt="20190924210701"
	
	
		class="gallery-image" 
		data-flex-grow="308"
		data-flex-basis="739px"
	
></p>
<p>é¦–å…ˆé…ç½®é¡¹ç›®çš„æ•°æ®æ¥æºï¼Œé€‰æ‹© SCMï¼Œå¹¶ä¸”é…ç½® Git è¿œç¨‹ä»“åº“çš„åœ°å€ï¼Œå¦‚æœæ˜¯ç§æœ‰ä»“åº“åˆ™è¿˜éœ€è¦è®¾ç½®ç”¨æˆ·åå’Œå¯†ç ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569330833479.png"
	width="2886"
	height="1498"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569330833479_huf375df774c6d8359d4b998504cf49c2b_267894_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569330833479_huf375df774c6d8359d4b998504cf49c2b_267894_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569330833479"
	
	
		class="gallery-image" 
		data-flex-grow="192"
		data-flex-basis="462px"
	
></p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569330858800.png"
	width="2873"
	height="1092"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569330858800_hu2a8b18bb77abc4f7894f60818761fabe_117614_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569330858800_hu2a8b18bb77abc4f7894f60818761fabe_117614_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569330858800"
	
	
		class="gallery-image" 
		data-flex-grow="263"
		data-flex-basis="631px"
	
></p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569330897596.png"
	width="1854"
	height="275"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569330897596_hucbde5b5a5a9c898ea35a2aaf23443bff_37749_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569330897596_hucbde5b5a5a9c898ea35a2aaf23443bff_37749_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569330897596"
	
	
		class="gallery-image" 
		data-flex-grow="674"
		data-flex-basis="1618px"
	
></p>
<h3 id="32-jenkins-çš„-webhook-é…ç½®">3.2 Jenkins çš„ Webhook é…ç½®</h3>
<p>æµæ°´çº¿é¡¹ç›®å»ºç«‹å®Œæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è®¾ç½® Generic WebHook Trigger çš„ä¸€äº›å‚æ•°ï¼Œä»¥ä¾¿è®©è¿œç¨‹çš„ Gogs èƒ½å¤Ÿè§¦å‘æ„å»ºä»»åŠ¡ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569331415017.png"
	width="2924"
	height="646"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569331415017_hud2284df3cf1724649a123ca347391870_88867_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569331415017_hud2284df3cf1724649a123ca347391870_88867_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569331415017"
	
	
		class="gallery-image" 
		data-flex-grow="452"
		data-flex-basis="1086px"
	
></p>
<p>æˆ‘ä»¬ä¸º TestProject åˆ›å»ºä¸€ä¸ª Tokenï¼Œè¿™ä¸ª Token æ˜¯è·Ÿæµæ°´çº¿ä»»åŠ¡ç»‘å®šäº†ï¼Œè¯´ç™½äº†å°±æ˜¯æµæ°´çº¿ä»»åŠ¡çš„ä¸€ä¸ªæ ‡è¯†ã€‚å»ºè®®ä½¿ç”¨éšæœº Guid ä½œä¸º Tokenï¼Œä¸ç„¶å…¶ä»–äººéƒ½å¯ä»¥éšä¾¿è§¦å‘ä½ çš„æµæ°´çº¿ä»»åŠ¡è¿›è¡Œæ„å»ºäº†ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569334122415.png"
	width="2865"
	height="1530"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569334122415_hu26f931aa342f51c8c56adfa84b9ab9a5_300448_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569334122415_hu26f931aa342f51c8c56adfa84b9ab9a5_300448_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569334122415"
	
	
		class="gallery-image" 
		data-flex-grow="187"
		data-flex-basis="449px"
	
></p>
<h3 id="33-gogs-çš„-webhook-é…ç½®">3.3 Gogs çš„ Webhook é…ç½®</h3>
<p>æ¥ç€æ¥åˆ°åˆšåˆšæˆ‘ä»¬å»ºå¥½çš„ä»“åº“ï¼Œæ‰¾åˆ° <strong>ä»“åº“è®¾ç½®-&gt;ç®¡ç† Web é’©å­-&gt;æ·»åŠ  Web é’©å­-&gt;Gogs</strong> ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569311317013.png"
	width="2436"
	height="998"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569311317013_hu4dd11577ea45f4613396f553ec32a489_160767_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569311317013_hu4dd11577ea45f4613396f553ec32a489_160767_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569311317013"
	
	
		class="gallery-image" 
		data-flex-grow="244"
		data-flex-basis="585px"
	
></p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569331737902.png"
	width="2155"
	height="1869"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569331737902_hu0fb3ad5524967b89dfb8d01dc5415872_381628_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569331737902_hu0fb3ad5524967b89dfb8d01dc5415872_381628_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569331737902"
	
	
		class="gallery-image" 
		data-flex-grow="115"
		data-flex-basis="276px"
	
></p>
<p>å› ä¸ºè§¦å‘æ„å»ºä¸å¯èƒ½æ¯æ¬¡æäº¤éƒ½è§¦å‘ï¼Œä¸€èˆ¬æ¥è¯´éƒ½æ˜¯åˆ›å»ºäº†æŸä¸ªåˆå¹¶è¯·æ±‚ï¼Œæˆ–è€…å‘å¸ƒæ–°ç‰ˆæœ¬çš„æ—¶å€™å°±ä¼šè§¦å‘æµæ°´çº¿ä»»åŠ¡ã€‚å› æ­¤è¿™é‡Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µæ¥é€‰æ‹©è§¦å‘äº‹ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¥åˆå¹¶è¯·æ±‚ä¸ºä¾‹ï¼Œä½ å¯ä»¥åœ¨é’©å­è®¾ç½®é¡µé¢ç‚¹å‡» <strong>æµ‹è¯•æ¨é€</strong>ã€‚è¿™æ ·å°±å¯ä»¥çœ‹åˆ° Gogs å‘é€ç»™ Jenkins çš„ JSON ç»“æ„æ˜¯æ€æ ·çš„ï¼Œä½ å°±èƒ½å¤Ÿåœ¨ Jenkins é‚£è¾¹æœ‰æ¡ä»¶çš„è¿›è¡Œå¤„ç†ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569331889328.png"
	width="1581"
	height="649"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569331889328_hu6030bfb72df541ba091fd7c66f62c796_61601_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569331889328_hu6030bfb72df541ba091fd7c66f62c796_61601_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569331889328"
	
	
		class="gallery-image" 
		data-flex-grow="243"
		data-flex-basis="584px"
	
></p>
<p>ä¸è¿‡æµ‹è¯•æ¨é€åªèƒ½å¤Ÿé’ˆå¯¹æ™®é€šçš„ push äº‹ä»¶è¿›è¡Œæµ‹è¯•ï¼Œåƒ <strong>åˆå¹¶è¯·æ±‚</strong> æˆ–è€… <strong>ç‰ˆæœ¬å‘å¸ƒ</strong> è¿™ç§äº‹ä»¶åªèƒ½è‡ªå·±æ¨¡æ‹Ÿæ“ä½œäº†ã€‚åœ¨è¿™é‡Œæˆ‘æ–°å»ºäº†ä¸€ä¸ªç”¨æˆ·ï¼ŒFork äº†å¦ä¸€ä¸ªå¸å·å»ºç«‹çš„ TestProject ä»“åº“ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569333744053.png"
	width="2049"
	height="1008"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569333744053_hufe8f55118e891bd0117265ad5014f6a0_184477_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569333744053_hufe8f55118e891bd0117265ad5014f6a0_184477_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569333744053"
	
	
		class="gallery-image" 
		data-flex-grow="203"
		data-flex-basis="487px"
	
></p>
<p>åœ¨ Fork çš„ä»“åº“é‡Œé¢ï¼Œæˆ‘æ–°å»ºäº†ä¸€ä¸ª Readme.md æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»åˆ›å»ºåˆå¹¶ï¼Œè¿™ä¸ªæ—¶å€™ä½ çœ‹ Gogs çš„ WebHook æ¨é€è®°å½•å°±æœ‰ä¸€æ¡æ–°çš„æ•°æ®æ¨é€ç»™ Jenkinsï¼ŒåŒæ—¶ä½ ä¹Ÿå¯ä»¥åœ¨ Jenkins çœ‹åˆ°æµæ°´çº¿ä»»åŠ¡è¢«è§¦å‘äº†ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569333872900.png"
	width="2339"
	height="1509"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569333872900_hu4e24f3ba2f2b3df865e4035f27c70f58_136895_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569333872900_hu4e24f3ba2f2b3df865e4035f27c70f58_136895_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569333872900"
	
	
		class="gallery-image" 
		data-flex-grow="155"
		data-flex-basis="372px"
	
></p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569333943683.png"
	width="1635"
	height="1650"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569333943683_huee82677301f48e64d8c4dbdb2ff39299_217576_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569333943683_huee82677301f48e64d8c4dbdb2ff39299_217576_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569333943683"
	
	
		class="gallery-image" 
		data-flex-grow="99"
		data-flex-basis="237px"
	
></p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569333895518.png"
	width="1382"
	height="1211"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569333895518_hudc7b8ceb3619443fe25a75fdd362b699_206931_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569333895518_hudc7b8ceb3619443fe25a75fdd362b699_206931_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569333895518"
	
	
		class="gallery-image" 
		data-flex-grow="114"
		data-flex-basis="273px"
	
></p>
<h3 id="34-é™å®šä»»åŠ¡è§¦å‘æ¡ä»¶">3.4 é™å®šä»»åŠ¡è§¦å‘æ¡ä»¶</h3>
<p>é€šè¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å·²ç»å°† Gogs å’Œ Jenkins ä¸­çš„å…·ä½“ä»»åŠ¡è¿›è¡Œäº†ç»‘å®šã€‚ä¸è¿‡è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå°´å°¬çš„é—®é¢˜æ˜¯ï¼ŒGogs çš„åˆå¹¶äº‹ä»¶ä¸ä»…ä»…åŒ…æ‹¬åˆ›å»ºåˆå¹¶ï¼Œå®ƒçš„åŸå§‹æè¿°æ˜¯è¿™æ ·è¯´çš„ã€‚</p>
<blockquote>
<p>åˆå¹¶è¯·æ±‚äº‹ä»¶åŒ…æ‹¬åˆå¹¶è¢«å¼€å¯ã€å…³é—­ã€é‡æ–°å¼€å¯ã€ç¼–è¾‘ã€æŒ‡æ´¾ã€å–æ¶ˆæŒ‡æ´¾ã€æ›´æ–°æ ‡ç­¾ã€æ¸…é™¤æ ‡ç­¾ã€è®¾ç½®é‡Œç¨‹ç¢‘ã€å–æ¶ˆè®¾ç½®é‡Œç¨‹ç¢‘æˆ–ä»£ç åŒæ­¥ã€‚</p>
</blockquote>
<p>å¦‚æœæˆ‘ä»¬ä»…ä»…æ˜¯ä¾é ä¸Šé¢çš„é…ç½®ï¼Œé‚£ä¹ˆä¸Šè¿°æ‰€æœ‰è¡Œä¸ºéƒ½ä¼šè§¦å‘æ„å»ºæ“ä½œï¼Œè¿™è‚¯å®šä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœã€‚è¿˜å¥½ Generic Webhook ä¸ºæˆ‘ä»¬æä¾›äº†å˜é‡è·å–ï¼Œä»¥åŠ Webhook è¿‡æ»¤ã€‚</p>
<p>æˆ‘ä»¬ä» Gogs å‘å¾€ Jenkins çš„è¯·æ±‚ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ JSON å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª <code>action</code> å­—æ®µï¼Œé‡Œé¢å°±æ˜¯æœ¬æ¬¡çš„æ“ä½œæ ‡è¯†ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æƒ³åˆ°é€šè¿‡åˆ¤æ–­ <code>action</code> å­—æ®µæ˜¯å¦ç­‰äº <code>opened </code>æ¥è§¦å‘æµæ°´çº¿ä»»åŠ¡ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å¢åŠ  4 ä¸ª <strong>Post content parameters</strong> å‚æ•°ï¼Œåˆ†åˆ«è·å–åˆ° Gogs ä¼ é€’è¿‡æ¥çš„ <code>action</code> å’Œ PR çš„ Idï¼Œè¿™é‡Œæˆ‘è§£é‡Šä¸€ä¸‹å‡ ä¸ªæ–‡æœ¬æ¡†çš„æ„æ€ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569335075858.png"
	width="2796"
	height="1006"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569335075858_hub1d8addb29ac2db4259ecdf23bd05ac3_190077_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569335075858_hub1d8addb29ac2db4259ecdf23bd05ac3_190077_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569335075858"
	
	
		class="gallery-image" 
		data-flex-grow="277"
		data-flex-basis="667px"
	
></p>
<p>é™¤äº†è¿™ä¸¤ä¸ª Post å‚æ•°ä»¥å¤–ï¼Œåœ¨è¯·æ±‚å¤´ä¸­ï¼ŒGogs è¿˜æºå¸¦äº†å…·ä½“äº‹ä»¶ï¼Œæˆ‘ä»¬å°†å…¶ä¸€èµ·ä½œä¸ºè¿‡æ»¤æ¡ä»¶ã€‚<strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé’ˆå¯¹äºè¯·æ±‚å¤´çš„å‚æ•°ï¼Œåœ¨è½¬æ¢æˆå˜é‡æ—¶ï¼Œæ’ä»¶ä¼šå°†å­—ç¬¦è½¬ä¸ºå°å†™ï¼Œå¹¶ä¼šä½¿ç”¨ &lsquo;_&rsquo; ä»£æ›¿ &lsquo;-&rsquo;ã€‚</strong></p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569335210285.png"
	width="2745"
	height="587"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569335210285_huf51df76435bbe6616e9b6282da9735f3_103070_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569335210285_huf51df76435bbe6616e9b6282da9735f3_103070_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569335210285"
	
	
		class="gallery-image" 
		data-flex-grow="467"
		data-flex-basis="1122px"
	
></p>
<p>æœ€åæˆ‘ä»¬ç¼–å†™ä¸€ä¸ª <strong>Optional filter</strong> ï¼Œå®ƒçš„ Expression å‚æ•°æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸‹é¢çš„ Text å³æ˜¯æºå­—ç¬¦ä¸²ã€‚å®ç°å¾ˆç®€å•ï¼Œå½“ Text é‡Œé¢çš„å†…å®¹æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘æµæ°´çº¿ä»»åŠ¡ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬çš„ Text å­—ç¬¦ä¸²å°±æ˜¯ç”±ä¸Šé¢ä¸‰ä¸ªå˜é‡çš„å€¼ç»„æˆï¼Œç„¶åå’Œæˆ‘ä»¬é¢„æœŸçš„å€¼è¿›è¡ŒåŒ¹é…å³å¯ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569335465457.png"
	width="2422"
	height="468"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569335465457_hu4f02a3d67ef3907121c5a6eeee390333_93947_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569335465457_hu4f02a3d67ef3907121c5a6eeee390333_93947_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569335465457"
	
	
		class="gallery-image" 
		data-flex-grow="517"
		data-flex-basis="1242px"
	
></p>
<blockquote>
<p>å½“ç„¶ï¼Œä½ è¿˜æƒ³æ•´ä¸€äº›æ›´åŠ ç‚«é…·çš„åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨ Jenkins æä¾›çš„ Http Request ä¹‹ç±»çš„æ’ä»¶ã€‚å› ä¸º Gogs æä¾›äº† API æ¥å£ï¼Œä½ å°±å¯ä»¥åœ¨æ„å»ºå®Œæˆä¹‹åï¼Œå›å†™ç»™ Gogsï¼Œç”¨äºæç¤ºæ„å»ºç»“æœã€‚</p>
<p>è¿™æ ·çš„è¯ï¼Œè¿™ç§åŠŸèƒ½å°±æœ‰ç‚¹åƒ Github ä¸Šé¢çš„æœºå™¨äººå¸å·äº†ã€‚</p>
</blockquote>
<h2 id="å››å®Œæ•´çš„é¡¹ç›®ç¤ºä¾‹">å››ã€å®Œæ•´çš„é¡¹ç›®ç¤ºä¾‹</h2>
<p>åœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬é€šè¿‡ Jenkins çš„æ’ä»¶å®Œæˆäº†è¿œç¨‹ä»“åº“æ¨é€é€šçŸ¥ï¼Œå½“æˆ‘ä»¬åˆå¹¶ä»£ç æ—¶ï¼ŒJenkins ä¼šè‡ªåŠ¨è§¦å‘æ‰§è¡Œæˆ‘ä»¬çš„ç®¡é“ä»»åŠ¡ã€‚æ¥ä¸‹æ¥æˆ‘å°†å»ºç«‹ä¸€ä¸ª .NET Core é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ‹¥æœ‰ä¸€ä¸ª Controllerï¼Œæ¥æ”¶åˆ°è¯·æ±‚ä¹‹åè¾“å‡º â€œHello Worldâ€ã€‚éšåä¸ºè¯¥é¡¹ç›®å»ºç«‹ä¸€ä¸ª xUnit çš„æµ‹è¯•é¡¹ç›®ï¼Œç”¨äºæ‰§è¡Œå•å…ƒæµ‹è¯•ã€‚</p>
<p>æ•´ä¸ªé¡¹ç›®çš„ç»“æ„å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569319357702.png"
	width="652"
	height="582"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569319357702_hub5fbb990ae23cdbfcec8ec51f9c825e9_27201_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569319357702_hub5fbb990ae23cdbfcec8ec51f9c825e9_27201_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569319357702"
	
	
		class="gallery-image" 
		data-flex-grow="112"
		data-flex-basis="268px"
	
></p>
<p>æˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ª <code>UnitTest.Dockerfile</code> é•œåƒï¼Œç”¨äºæ‰§è¡Œ xUnit å•å…ƒæµ‹è¯•ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> mcr.microsoft.com/dotnet/core/sdk:2.2</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># è¿˜åŸ NuGet åŒ…ã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /home/app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> ./ ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> dotnet restore<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;dotnet&#34;</span><span class="p">,</span> <span class="s2">&#34;test&#34;</span> <span class="p">,</span> <span class="s2">&#34;--verbosity=normal&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ä¹‹åä¸ºéƒ¨ç½²æ“ä½œç¼–å†™ä¸€ä¸ª <code>Deploy.Dockerfile</code> ï¼Œè¿™ä¸ª Dockerfile é¦–å…ˆè¿˜åŸäº† NuGet åŒ…ï¼Œç„¶åé€šè¿‡ <code>dotnet publish</code> å‘½ä»¤å‘å¸ƒäº†æˆ‘ä»¬çš„ç½‘ç«™ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> mcr.microsoft.com/dotnet/core/sdk:2.2 as build-image</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># è¿˜åŸ NuGet åŒ…ã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /home/app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> ./ ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> dotnet restore<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># å‘å¸ƒé•œåƒã€‚</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> ./ ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> dotnet publish ./TestProject.WebApi/TestProject.WebApi.csproj -o /publish/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> mcr.microsoft.com/dotnet/core/aspnet:2.2</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /publish</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>build-image /publish .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;dotnet&#34;</span><span class="p">,</span> <span class="s2">&#34;TestProject.WebApi.dll&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸¤ä¸ª Dockerfile ç¼–å†™å®Œæˆä¹‹åï¼Œå°†å…¶å­˜æ”¾åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ï¼Œä»¥ä¾¿ Slave è¿›è¡Œæ„å»ºã€‚</p>
<p>Dockerfile ç¼–å†™å¥½äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜è¦åˆ†åˆ«ä¸ºä¸¤ä¸ªé•œåƒç¼–å†™ Docker Compose æ–‡ä»¶ï¼Œç”¨äºæ‰§è¡Œå•å…ƒæµ‹è¯•å’Œéƒ¨ç½²è¡Œä¸ºï¼Œç”¨äºéƒ¨ç½²çš„æ–‡ä»¶åç§°å«åš <code>docker-compose.Deploy.yaml</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">dev-test-backend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">dev-test:B${BUILD_NUMBER}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s1">&#39;5000:5000&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæˆ‘ä»¬éœ€è¦ç¼–å†™è¿è¡Œå•å…ƒæµ‹è¯•çš„ Docker Compose æ–‡ä»¶ï¼Œåå­—å«åš <code>docker-compose.UnitTest.yaml</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">dev-test-unit-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">dev-test:TEST${BUILD_NUMBER}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="äº”ç¼–å†™-jenkinsfile">äº”ã€ç¼–å†™ Jenkinsfile</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">node(&#39;docker&#39;) {
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    stage &#39;ç­¾å‡ºä»£ç &#39;
</span></span><span class="line"><span class="cl">        checkout scm
</span></span><span class="line"><span class="cl">    stage &#39;å•å…ƒæµ‹è¯•&#39;
</span></span><span class="line"><span class="cl">        sh &#34;docker build -t dev-test:TEST${BUILD_NUMBER} -f UnitTest.Dockerfile .&#34;
</span></span><span class="line"><span class="cl">        sh &#34;docker-compose -f docker-compose.UnitTest.yaml up --force-recreate --abort-on-container-exit&#34;
</span></span><span class="line"><span class="cl">        sh &#34;docker-compose -f docker-compose.UnitTest.yaml down -v&#34;
</span></span><span class="line"><span class="cl">    stage &#39;éƒ¨ç½²é¡¹ç›®&#39;
</span></span><span class="line"><span class="cl">        sh &#34;docker build -t dev-test:B${BUILD_NUMBER} -f Deploy.Dockerfile .&#34;
</span></span><span class="line"><span class="cl">        sh &#39;docker-compose -f docker-compose.Deploy.yaml up -d&#39;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å…­æœ€åçš„æ•ˆæœ">å…­ã€æœ€åçš„æ•ˆæœ</h2>
<p>ä¸Šè¿°æ“ä½œå®Œæˆä¹‹åï¼Œå°†è¿™äº›æ–‡ä»¶æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569342792065.png"
	width="1982"
	height="737"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569342792065_hu358f8da16c3be33ab3fab64c57a6129c_169831_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569342792065_hu358f8da16c3be33ab3fab64c57a6129c_169831_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569342792065"
	
	
		class="gallery-image" 
		data-flex-grow="268"
		data-flex-basis="645px"
	
></p>
<p>å›åˆ° Jenkinsï¼Œä½ å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸‹ä»»åŠ¡ï¼Œç„¶åé¡¹ç›®å°±è¢«æˆåŠŸæ‰§è¡Œäº†ã€‚</p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569342849864.png"
	width="3831"
	height="1362"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569342849864_hu96e02516599d5f0fe503257b4b97e1e7_320697_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569342849864_hu96e02516599d5f0fe503257b4b97e1e7_320697_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569342849864"
	
	
		class="gallery-image" 
		data-flex-grow="281"
		data-flex-basis="675px"
	
></p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569342887871.png"
	width="3740"
	height="1808"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569342887871_hu99442620474d692a7b59fa8df01e7b4c_435041_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569342887871_hu99442620474d692a7b59fa8df01e7b4c_435041_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569342887871"
	
	
		class="gallery-image" 
		data-flex-grow="206"
		data-flex-basis="496px"
	
></p>
<p><img src="/p/jenkins-combines-docker-to-implement-low-level-ci/1569342899658.png"
	width="3775"
	height="868"
	srcset="/p/jenkins-combines-docker-to-implement-low-level-ci/1569342899658_hub2aef015a7251f2972a330850af6a8ad_106869_480x0_resize_box_3.png 480w, /p/jenkins-combines-docker-to-implement-low-level-ci/1569342899658_hub2aef015a7251f2972a330850af6a8ad_106869_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="1569342899658"
	
	
		class="gallery-image" 
		data-flex-grow="434"
		data-flex-basis="1043px"
	
></p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„ â€œä½é…ç‰ˆâ€ CIã€CD ç¯å¢ƒå°±æ­å»ºæˆåŠŸäº†ã€‚</p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/jenkins/">Jenkins</a>
        
            <a href="/tags/docker/">Docker</a>
        
            <a href="/tags/ci/cd/">CI/CD</a>
        
            <a href="/tags/docker-compose/">Docker Compose</a>
        
            <a href="/tags/devops/">DevOps</a>
        
            <a href="/tags/linux/">Linux</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/continuous-integrationdeployment-for-net-core-with-jenkins/">
        
        

        <div class="article-details">
            <h2 class="article-title">ä½¿ç”¨ Jenkins ä¸º .Net Core å®ç°æŒç»­é›†æˆ/éƒ¨ç½²</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/install-docker-compose-on-centos-7x/">
        
        

        <div class="article-details">
            <h2 class="article-title">CentOS 7.x å®‰è£… Docker-Compose</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/harbor-212-installation-and-deployment/">
        
        

        <div class="article-details">
            <h2 class="article-title">Harbor 2.1.2 å®‰è£…éƒ¨ç½²</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/docker-container-directory-garbled-problem-with-dotnet-core/">
        
        

        <div class="article-details">
            <h2 class="article-title">dotNET Core çš„ Docker å®¹å™¨ç›®å½•ä¹±ç é—®é¢˜</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/docker-install-elk/">
        
        

        <div class="article-details">
            <h2 class="article-title">Docker å®‰è£… ELK</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="real-zony/real-zony.github.io"
    data-repo-id="R_kgDOIC_OeA"
    data-category="General"
    data-category-id="DIC_kwDOIC_OeM4CRp3M"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="en"
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('preferred_color_scheme');
            } else {
                setGiscusTheme('preferred_color_scheme');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Zony çš„åšå®¢
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#ä¸€jenkins-çš„éƒ¨ç½²">ä¸€ã€Jenkins çš„éƒ¨ç½²</a>
      <ol>
        <li><a href="#11-æ„å»º-master-é•œåƒ">1.1 æ„å»º Master é•œåƒ</a></li>
        <li><a href="#12-æ„å»º-slave-é•œåƒ">1.2 æ„å»º Slave é•œåƒ</a></li>
        <li><a href="#13-ç¼–å†™-docker-compose-æ–‡ä»¶">1.3 ç¼–å†™ Docker Compose æ–‡ä»¶</a></li>
      </ol>
    </li>
    <li><a href="#äºŒgogs-çš„éƒ¨ç½²">äºŒã€Gogs çš„éƒ¨ç½²</a></li>
    <li><a href="#ä¸‰gogs-ä¸-jenkins-çš„é›†æˆ">ä¸‰ã€Gogs ä¸ Jenkins çš„é›†æˆ</a>
      <ol>
        <li><a href="#31-åˆ›å»ºæµæ°´çº¿é¡¹ç›®">3.1 åˆ›å»ºæµæ°´çº¿é¡¹ç›®</a></li>
        <li><a href="#32-jenkins-çš„-webhook-é…ç½®">3.2 Jenkins çš„ Webhook é…ç½®</a></li>
        <li><a href="#33-gogs-çš„-webhook-é…ç½®">3.3 Gogs çš„ Webhook é…ç½®</a></li>
        <li><a href="#34-é™å®šä»»åŠ¡è§¦å‘æ¡ä»¶">3.4 é™å®šä»»åŠ¡è§¦å‘æ¡ä»¶</a></li>
      </ol>
    </li>
    <li><a href="#å››å®Œæ•´çš„é¡¹ç›®ç¤ºä¾‹">å››ã€å®Œæ•´çš„é¡¹ç›®ç¤ºä¾‹</a></li>
    <li><a href="#äº”ç¼–å†™-jenkinsfile">äº”ã€ç¼–å†™ Jenkinsfile</a></li>
    <li><a href="#å…­æœ€åçš„æ•ˆæœ">å…­ã€æœ€åçš„æ•ˆæœ</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
