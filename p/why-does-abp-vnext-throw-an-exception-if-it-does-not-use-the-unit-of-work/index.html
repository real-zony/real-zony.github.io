<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='‰∏Ä„ÄÅÈóÆÈ¢ò ËØ•ÈóÆÈ¢òÁªèÂ∏∏Âá∫Áé∞Âú® ABP vNext Ê°ÜÊû∂ÂΩì‰∏≠ÔºåË¶ÅÂ§çÁé∞ËØ•ÈóÆÈ¢òÂçÅÂàÜÁÆÄÂçïÔºåÂè™ÈúÄË¶Å‰Ω†Ê≥®ÂÖ•‰∏Ä‰∏™ IRepository&amp;lt;T,TKey&amp;gt; ‰ªìÂÇ®ÔºåÂú®‰ªªÊÑè‰∏Ä‰∏™Âú∞ÊñπË∞ÉÁî® IRepository&amp;lt;T,TKey&amp;gt;.ToList() ÊñπÊ≥ï„ÄÇ
1 2 3 4 5 6 7 [Fact] public void TestMethod() { var rep = GetRequiredService&amp;lt;IHospitalRepository&amp;gt;(); var result = rep.ToList(); } ‰æãÂ¶Ç‰∏äÈù¢ÁöÑÊµãËØï‰ª£Á†ÅÔºå‰∏çÂá∫ÊÑèÂ§ñÂ∞±‰ºöÊèêÁ§∫ System.ObjectDisposedException ÂºÇÂ∏∏ÔºåÂÖ∑‰ΩìÁöÑÂºÇÂ∏∏ÂÜÖÂÆπ‰ø°ÊÅØÔºö
1 System.ObjectDisposedException : Cannot access a disposed object. A common cause of this error is disposing a context that was resolved from dependency injection and then later trying to use the same context instance elsewhere in your application. This may occur if you are calling Dispose() on the context, or wrapping the context in a using statement. If you are using dependency injection, you should let the dependency injection container take care of disposing context instances. ÂÖ∂ÂÆûÂ∑≤ÁªèËØ¥ÂæóÂçÅÂàÜÊòéÁôΩ‰∫ÜÔºåÂõ†‰∏∫‰Ω†Ë¶ÅË∞ÉÁî®ÁöÑ DbContext Â∑≤ÁªèË¢´ÈáäÊîæ‰∫ÜÔºåÊâÄ‰ª•‰ºöÂá∫Áé∞Ëøô‰∏™ÂºÇÂ∏∏‰ø°ÊÅØ„ÄÇ
'><title>ABP vNext ‰∏ç‰ΩøÁî®Â∑•‰ΩúÂçïÂÖÉ‰∏∫‰ªÄ‰πà‰ºöÊäõÂá∫ÂºÇÂ∏∏</title>

<link rel='canonical' href='https://real-zony.github.io/p/why-does-abp-vnext-throw-an-exception-if-it-does-not-use-the-unit-of-work/'>

<link rel="stylesheet" href="/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css"><meta property='og:title' content='ABP vNext ‰∏ç‰ΩøÁî®Â∑•‰ΩúÂçïÂÖÉ‰∏∫‰ªÄ‰πà‰ºöÊäõÂá∫ÂºÇÂ∏∏'>
<meta property='og:description' content='‰∏Ä„ÄÅÈóÆÈ¢ò ËØ•ÈóÆÈ¢òÁªèÂ∏∏Âá∫Áé∞Âú® ABP vNext Ê°ÜÊû∂ÂΩì‰∏≠ÔºåË¶ÅÂ§çÁé∞ËØ•ÈóÆÈ¢òÂçÅÂàÜÁÆÄÂçïÔºåÂè™ÈúÄË¶Å‰Ω†Ê≥®ÂÖ•‰∏Ä‰∏™ IRepository&amp;lt;T,TKey&amp;gt; ‰ªìÂÇ®ÔºåÂú®‰ªªÊÑè‰∏Ä‰∏™Âú∞ÊñπË∞ÉÁî® IRepository&amp;lt;T,TKey&amp;gt;.ToList() ÊñπÊ≥ï„ÄÇ
1 2 3 4 5 6 7 [Fact] public void TestMethod() { var rep = GetRequiredService&amp;lt;IHospitalRepository&amp;gt;(); var result = rep.ToList(); } ‰æãÂ¶Ç‰∏äÈù¢ÁöÑÊµãËØï‰ª£Á†ÅÔºå‰∏çÂá∫ÊÑèÂ§ñÂ∞±‰ºöÊèêÁ§∫ System.ObjectDisposedException ÂºÇÂ∏∏ÔºåÂÖ∑‰ΩìÁöÑÂºÇÂ∏∏ÂÜÖÂÆπ‰ø°ÊÅØÔºö
1 System.ObjectDisposedException : Cannot access a disposed object. A common cause of this error is disposing a context that was resolved from dependency injection and then later trying to use the same context instance elsewhere in your application. This may occur if you are calling Dispose() on the context, or wrapping the context in a using statement. If you are using dependency injection, you should let the dependency injection container take care of disposing context instances. ÂÖ∂ÂÆûÂ∑≤ÁªèËØ¥ÂæóÂçÅÂàÜÊòéÁôΩ‰∫ÜÔºåÂõ†‰∏∫‰Ω†Ë¶ÅË∞ÉÁî®ÁöÑ DbContext Â∑≤ÁªèË¢´ÈáäÊîæ‰∫ÜÔºåÊâÄ‰ª•‰ºöÂá∫Áé∞Ëøô‰∏™ÂºÇÂ∏∏‰ø°ÊÅØ„ÄÇ
'>
<meta property='og:url' content='https://real-zony.github.io/p/why-does-abp-vnext-throw-an-exception-if-it-does-not-use-the-unit-of-work/'>
<meta property='og:site_name' content='Zony ÁöÑÂçöÂÆ¢'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='C#' /><meta property='article:tag' content='ABP' /><meta property='article:tag' content='ABP vNext' /><meta property='article:tag' content='Â∑•‰ΩúÂçïÂÖÉ' /><meta property='article:tag' content='Entity Framework Core' /><meta property='article:tag' content='ÂºÇÂ∏∏Â§ÑÁêÜ' /><meta property='article:published_time' content='2019-10-15T13:12:10&#43;00:00'/><meta property='article:modified_time' content='2019-10-15T13:12:10&#43;00:00'/>
<meta name="twitter:title" content="ABP vNext ‰∏ç‰ΩøÁî®Â∑•‰ΩúÂçïÂÖÉ‰∏∫‰ªÄ‰πà‰ºöÊäõÂá∫ÂºÇÂ∏∏">
<meta name="twitter:description" content="‰∏Ä„ÄÅÈóÆÈ¢ò ËØ•ÈóÆÈ¢òÁªèÂ∏∏Âá∫Áé∞Âú® ABP vNext Ê°ÜÊû∂ÂΩì‰∏≠ÔºåË¶ÅÂ§çÁé∞ËØ•ÈóÆÈ¢òÂçÅÂàÜÁÆÄÂçïÔºåÂè™ÈúÄË¶Å‰Ω†Ê≥®ÂÖ•‰∏Ä‰∏™ IRepository&amp;lt;T,TKey&amp;gt; ‰ªìÂÇ®ÔºåÂú®‰ªªÊÑè‰∏Ä‰∏™Âú∞ÊñπË∞ÉÁî® IRepository&amp;lt;T,TKey&amp;gt;.ToList() ÊñπÊ≥ï„ÄÇ
1 2 3 4 5 6 7 [Fact] public void TestMethod() { var rep = GetRequiredService&amp;lt;IHospitalRepository&amp;gt;(); var result = rep.ToList(); } ‰æãÂ¶Ç‰∏äÈù¢ÁöÑÊµãËØï‰ª£Á†ÅÔºå‰∏çÂá∫ÊÑèÂ§ñÂ∞±‰ºöÊèêÁ§∫ System.ObjectDisposedException ÂºÇÂ∏∏ÔºåÂÖ∑‰ΩìÁöÑÂºÇÂ∏∏ÂÜÖÂÆπ‰ø°ÊÅØÔºö
1 System.ObjectDisposedException : Cannot access a disposed object. A common cause of this error is disposing a context that was resolved from dependency injection and then later trying to use the same context instance elsewhere in your application. This may occur if you are calling Dispose() on the context, or wrapping the context in a using statement. If you are using dependency injection, you should let the dependency injection container take care of disposing context instances. ÂÖ∂ÂÆûÂ∑≤ÁªèËØ¥ÂæóÂçÅÂàÜÊòéÁôΩ‰∫ÜÔºåÂõ†‰∏∫‰Ω†Ë¶ÅË∞ÉÁî®ÁöÑ DbContext Â∑≤ÁªèË¢´ÈáäÊîæ‰∫ÜÔºåÊâÄ‰ª•‰ºöÂá∫Áé∞Ëøô‰∏™ÂºÇÂ∏∏‰ø°ÊÅØ„ÄÇ
">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu88ff3bfa88d8ce73b9d64b435a0a3f2c_26917_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Zony ÁöÑÂçöÂÆ¢</a></h1>
            <h2 class="site-description">A .NET Developer</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/real-zony'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        

        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Â≠òÊ°£</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>ÊêúÁ¥¢</span>
            </a>
        </li>
        
        

        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://real-zony.github.io/en/" >English</option>
                        
                            <option value="https://real-zony.github.io/" selected>‰∏≠Êñá</option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>ÊöóËâ≤Ê®°Âºè</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/why-does-abp-vnext-throw-an-exception-if-it-does-not-use-the-unit-of-work/">ABP vNext ‰∏ç‰ΩøÁî®Â∑•‰ΩúÂçïÂÖÉ‰∏∫‰ªÄ‰πà‰ºöÊäõÂá∫ÂºÇÂ∏∏</a>
        </h2>
    
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Oct 15, 2019</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 5 ÂàÜÈíü
                </time>
            </div>
        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <h2 id="‰∏ÄÈóÆÈ¢ò">‰∏Ä„ÄÅÈóÆÈ¢ò</h2>
<p>ËØ•ÈóÆÈ¢òÁªèÂ∏∏Âá∫Áé∞Âú® ABP vNext Ê°ÜÊû∂ÂΩì‰∏≠ÔºåË¶ÅÂ§çÁé∞ËØ•ÈóÆÈ¢òÂçÅÂàÜÁÆÄÂçïÔºåÂè™ÈúÄË¶Å‰Ω†Ê≥®ÂÖ•‰∏Ä‰∏™ <code>IRepository&lt;T,TKey&gt;</code> ‰ªìÂÇ®ÔºåÂú®‰ªªÊÑè‰∏Ä‰∏™Âú∞ÊñπË∞ÉÁî® <code>IRepository&lt;T,TKey&gt;.ToList()</code> ÊñπÊ≥ï„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="na">[Fact]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">void</span> <span class="n">TestMethod</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">rep</span> <span class="p">=</span> <span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IHospitalRepository</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">rep</span><span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰æãÂ¶Ç‰∏äÈù¢ÁöÑÊµãËØï‰ª£Á†ÅÔºå‰∏çÂá∫ÊÑèÂ§ñÂ∞±‰ºöÊèêÁ§∫ <code>System.ObjectDisposedException</code> ÂºÇÂ∏∏ÔºåÂÖ∑‰ΩìÁöÑÂºÇÂ∏∏ÂÜÖÂÆπ‰ø°ÊÅØÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">System.ObjectDisposedException : Cannot access a disposed object. A common cause of this error is disposing a context that was resolved from dependency injection and then later trying to use the same context instance elsewhere in your application. This may occur if you are calling Dispose() on the context, or wrapping the context in a using statement. If you are using dependency injection, you should let the dependency injection container take care of disposing context instances.
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÖ∂ÂÆûÂ∑≤ÁªèËØ¥ÂæóÂçÅÂàÜÊòéÁôΩ‰∫ÜÔºåÂõ†‰∏∫‰Ω†Ë¶ÅË∞ÉÁî®ÁöÑ <code>DbContext</code> Â∑≤ÁªèË¢´ÈáäÊîæ‰∫ÜÔºåÊâÄ‰ª•‰ºöÂá∫Áé∞Ëøô‰∏™ÂºÇÂ∏∏‰ø°ÊÅØ„ÄÇ</p>
<h2 id="‰∫åÂéüÂõ†">‰∫å„ÄÅÂéüÂõ†</h2>
<h3 id="21-‰∏∫‰ªÄ‰πàËÉΩÂ§üË∞ÉÁî®-linq-Êâ©Â±ï">2.1 ‰∏∫‰ªÄ‰πàËÉΩÂ§üË∞ÉÁî® LINQ Êâ©Â±ï?</h3>
<p>Êàë‰ª¨‰πãÊâÄ‰ª•ËÉΩÂ§üÂú® <code>IRepository&lt;TEntity,TKey&gt;</code> Êé•Âè£‰∏äÈù¢ÔºåË∞ÉÁî® LINQ Áõ∏ÂÖ≥ÁöÑÊµÅÁïÖÊé•Âè£ÔºåÊòØÂõ†‰∏∫ÂÖ∂Áà∂Á∫ßÊé•Âè£ <code>IReadOnlyRepository&lt;TEntity,TKey&gt;</code> ÁªßÊâø‰∫Ü <code>IQueryable&lt;TEntity&gt;</code> Êé•Âè£„ÄÇÂ¶ÇÊûú‰ΩøÁî®ÁöÑÊòØ Entity Framework Core Ê°ÜÊû∂ÔºåÈÇ£‰πàÂú®Ëß£Êûê <code>IRepository&lt;T,Key&gt;</code> ÁöÑÊó∂ÂÄôÔºåÊàë‰ª¨ÂæóÂà∞ÁöÑÊòØ‰∏Ä‰∏™ <code>EfCoreRepository&lt;TDbContext, TEntity,TKey&gt;</code> ÂÆû‰æã„ÄÇ</p>
<p>ÈíàÂØπËøô‰∏™ÂÆû‰æãÔºåÁ±ªÂûã <code>EfCoreRepository&lt;TDbContext, TEntity&gt;</code> ÂàôÊòØÂÆÉÁöÑÂü∫Á±ªÂûãÔºåÁªßÁª≠Ë∑≥ËΩ¨Âà∞ÂÖ∂Âü∫Á±ª <code>RepositoryBase&lt;TEntity&gt;</code> Êàë‰ª¨Â∞±ËÉΩÁúãÂà∞ÂÆÉÂÆûÁé∞‰∫Ü <code>IQueryable&lt;T&gt;</code> Êé•Âè£ÂøÖÂ§áÁöÑÂá†‰∏™Â±ûÊÄß„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="k">class</span> <span class="nc">RepositoryBase</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">BasicRepositoryBase</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;,</span> <span class="n">IRepository</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">class</span><span class="p">,</span> <span class="n">IEntity</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ÂøΩÁï•ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">virtual</span> <span class="n">Type</span> <span class="n">ElementType</span> <span class="p">=&gt;</span> <span class="n">GetQueryable</span><span class="p">().</span><span class="n">ElementType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">virtual</span> <span class="n">Expression</span> <span class="n">Expression</span> <span class="p">=&gt;</span> <span class="n">GetQueryable</span><span class="p">().</span><span class="n">Expression</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">virtual</span> <span class="n">IQueryProvider</span> <span class="n">Provider</span> <span class="p">=&gt;</span> <span class="n">GetQueryable</span><span class="p">().</span><span class="n">Provider</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ÂøΩÁï•ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IEnumerator</span> <span class="n">IEnumerable</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">GetEnumerator</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">GetEnumerator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">GetQueryable</span><span class="p">().</span><span class="n">GetEnumerator</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">GetQueryable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ÂøΩÁï•ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-iqueryable-‰ΩøÁî®ÁöÑ-dbcontext">2.2 IQueryable ‰ΩøÁî®ÁöÑ DbContext</h3>
<p>‰∏ä‰∏Ä‰∏™Â∞èËäÇÁöÑ‰ª£Á†Å‰∏≠ÔºåÊàë‰ª¨ÂèØ‰ª•ÁúãÂá∫ÊúÄÂêéÁöÑ <code>IQueryable&lt;TEntity&gt;</code> ÊòØÈÄöËøáÊäΩË±°ÊñπÊ≥ï <code>GetQueryable()</code> ÂèñÂæóÁöÑ„ÄÇËøô‰∏™ÊäΩË±°ÊñπÊ≥ïÔºåÂú® EF Core ÂΩì‰∏≠ÁöÑÂÆûÁé∞Â¶Ç‰∏ã„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">EfCoreRepository</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">,</span> <span class="n">TEntity</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">RepositoryBase</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;,</span> <span class="n">IEfCoreRepository</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">where</span> <span class="n">TDbContext</span> <span class="p">:</span> <span class="n">IEfCoreDbContext</span>
</span></span><span class="line"><span class="cl">    <span class="k">where</span> <span class="n">TEntity</span> <span class="p">:</span> <span class="n">class</span><span class="p">,</span> <span class="n">IEntity</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">virtual</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">DbSet</span> <span class="p">=&gt;</span> <span class="n">DbContext</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">DbContext</span> <span class="n">IEfCoreRepository</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;.</span><span class="n">DbContext</span> <span class="p">=&gt;</span> <span class="n">DbContext</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">DbContext</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="k">virtual</span> <span class="n">TDbContext</span> <span class="n">DbContext</span> <span class="p">=&gt;</span> <span class="n">_dbContextProvider</span><span class="p">.</span><span class="n">GetDbContext</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">IDbContextProvider</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;</span> <span class="n">_dbContextProvider</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ÂøΩÁï•ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">EfCoreRepository</span><span class="p">(</span><span class="n">IDbContextProvider</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;</span> <span class="n">dbContextProvider</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_dbContextProvider</span> <span class="p">=</span> <span class="n">dbContextProvider</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ... ÂøΩÁï•ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ÂøΩÁï•ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kd">override</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">GetQueryable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">DbSet</span><span class="p">.</span><span class="n">AsQueryable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ÂøΩÁï•ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÊâÄ‰ª•Êàë‰ª¨Â∞±ÂèØ‰ª•Áü•ÈÅìÔºåÂΩìË∞ÉÁî® <code>IQueryable&lt;TEntity&gt;.ToList()</code> ÊñπÊ≥ïÊó∂ÔºåÂÆûÈôÖÊòØ‰ΩøÁî®ÁöÑ <code>IDbContextProvider&lt;TDbContext&gt;</code> Ëß£ÊûêÂá∫Êù•ÁöÑÊï∞ÊçÆÂ∫ì‰∏ä‰∏ãÊñáÂØπË±°„ÄÇ</p>
<p>Ë∑≥ËΩ¨Âà∞Ëøô‰∏™ DbContextProvider ÁöÑÂÖ∑‰ΩìÂÆûÁé∞ÔºåÂèØ‰ª•ÁúãÂà∞‰ªñÊòØÈÄöËøá <code>IUnitOfWorkManager</code>(<strong>Â∑•‰ΩúÂçïÂÖÉÁÆ°ÁêÜÂô®</strong>) ÂæóÂà∞ÂèØÁî®ÁöÑÂ∑•‰ΩúÂçïÂÖÉÔºåÁÑ∂ÂêéÈÄöËøáÂ∑•‰ΩúÂçïÂÖÉÊèê‰æõÁöÑ <code>IServiceProvider</code> Ëß£ÊûêÊâÄÈúÄË¶ÅÁöÑÊï∞ÊçÆÂ∫ì‰∏ä‰∏ãÊñáÂØπË±°„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">UnitOfWorkDbContextProvider</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IDbContextProvider</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="k">where</span> <span class="n">TDbContext</span> <span class="p">:</span> <span class="n">IEfCoreDbContext</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">IUnitOfWorkManager</span> <span class="n">_unitOfWorkManager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UnitOfWorkDbContextProvider</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">IUnitOfWorkManager</span> <span class="n">unitOfWorkManager</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_unitOfWorkManager</span> <span class="p">=</span> <span class="n">unitOfWorkManager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ‰∏äËø∞‰ª£Á†ÅÊúâÊâÄÁ≤æÁÆÄ„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TDbContext</span> <span class="n">GetDbContext</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">unitOfWork</span> <span class="p">=</span> <span class="n">_unitOfWorkManager</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ... ÂøΩÁï•ÈÉ®ÂàÜ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ÈáçÁÇπÂú® CreateDbContext() ÊñπÊ≥ïÂÜÖÈÉ®„ÄÇ</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">databaseApi</span> <span class="p">=</span> <span class="n">unitOfWork</span><span class="p">.</span><span class="n">GetOrAddDatabaseApi</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">dbContextKey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">EfCoreDatabaseApi</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;(</span>
</span></span><span class="line"><span class="cl">                <span class="n">CreateDbContext</span><span class="p">(</span><span class="n">unitOfWork</span><span class="p">,</span> <span class="n">connectionStringName</span><span class="p">,</span> <span class="n">connectionString</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">((</span><span class="n">EfCoreDatabaseApi</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;)</span><span class="n">databaseApi</span><span class="p">).</span><span class="n">DbContext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TDbContext</span> <span class="n">CreateDbContext</span><span class="p">(</span><span class="n">IUnitOfWork</span> <span class="n">unitOfWork</span><span class="p">,</span> <span class="kt">string</span> <span class="n">connectionStringName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">connectionString</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ... ÂøΩÁï•ÈÉ®ÂàÜ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">using</span> <span class="p">(</span><span class="n">DbContextCreationContext</span><span class="p">.</span><span class="n">Use</span><span class="p">(</span><span class="n">creationContext</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">CreateDbContext</span><span class="p">(</span><span class="n">unitOfWork</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ... ÂøΩÁï•ÈÉ®ÂàÜ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">dbContext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TDbContext</span> <span class="n">CreateDbContext</span><span class="p">(</span><span class="n">IUnitOfWork</span> <span class="n">unitOfWork</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">unitOfWork</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">IsTransactional</span>
</span></span><span class="line"><span class="cl">            <span class="p">?</span> <span class="n">CreateDbContextWithTransaction</span><span class="p">(</span><span class="n">unitOfWork</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ÈáçÁÇπ ÔºÅÔºÅÔºÅ</span>
</span></span><span class="line"><span class="cl">            <span class="p">:</span> <span class="n">unitOfWork</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TDbContext</span> <span class="n">CreateDbContextWithTransaction</span><span class="p">(</span><span class="n">IUnitOfWork</span> <span class="n">unitOfWork</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ... ÂøΩÁï•ÈÉ®ÂàÜ‰ª£Á†Å„ÄÇ        </span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">activeTransaction</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ÈáçÁÇπ ÔºÅÔºÅÔºÅ</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">unitOfWork</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ... ÂøΩÁï•ÈÉ®ÂàÜ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">dbContext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ... ÂøΩÁï•ÈÉ®ÂàÜ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ÈáçÁÇπ ÔºÅÔºÅÔºÅ</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">unitOfWork</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ... ÂøΩÁï•ÈÉ®ÂàÜ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">dbContext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="23-dbcontext-ÂíåÂ∑•‰ΩúÂçïÂÖÉÁöÑÈîÄÊØÅ">2.3 DbContext ÂíåÂ∑•‰ΩúÂçïÂÖÉÁöÑÈîÄÊØÅ</h3>
<p>ÂèØ‰ª•ÁúãÂà∞Ôºå‰ªìÂÇ®‰ΩøÁî®Âà∞ÁöÑÊï∞ÊçÆÂ∫ì‰∏ä‰∏ãÊñáÂØπË±°ÊòØÈÄöËøáÂ∑•‰ΩúÂçïÂÖÉÁöÑ <code>IServiceProvider</code> ËøõË°åËß£ÊûêÁöÑ„ÄÇÂõûÊÉ≥‰πãÂâçÂÖ≥‰∫éÂ∑•‰ΩúÂçïÂÖÉÁöÑÊñáÁ´†ËÆ≤Ëß£Ôºå‰∏çËÆ∫ÊòØÊâãÂä®ÂºÄÂêØÂ∑•‰ΩúÂçïÂÖÉÔºåËøòÊòØÈÄöËøáÊã¶Êà™Âô®ÊàñËÄÖÁâπÊÄßÁöÑÊñπÂºèÂºÄÂêØÔºåÊúÄÁªàÈÉΩÊòØ‰ΩøÁî®ÁöÑ <code>IUnitOfWorkManager.Begin()</code> ËøõË°åÊûÑÂª∫ÁöÑ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">UnitOfWorkManager</span> <span class="p">:</span> <span class="n">IUnitOfWorkManager</span><span class="p">,</span> <span class="n">ISingletonDependency</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ÁúÅÁï•ÁöÑ‰∏çÁõ∏ÂÖ≥ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">IHybridServiceScopeFactory</span> <span class="n">_serviceScopeFactory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ÁúÅÁï•ÁöÑ‰∏çÁõ∏ÂÖ≥ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">IUnitOfWork</span> <span class="n">Begin</span><span class="p">(</span><span class="n">UnitOfWorkOptions</span> <span class="n">options</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">requiresNew</span> <span class="p">=</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ... ÁúÅÁï•ÁöÑ‰∏çÁõ∏ÂÖ≥ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">unitOfWork</span> <span class="p">=</span> <span class="n">CreateNewUnitOfWork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ... ÁúÅÁï•ÁöÑ‰∏çÁõ∏ÂÖ≥ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">unitOfWork</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ÁúÅÁï•ÁöÑ‰∏çÁõ∏ÂÖ≥ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IUnitOfWork</span> <span class="n">CreateNewUnitOfWork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">_serviceScopeFactory</span><span class="p">.</span><span class="n">CreateScope</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ... ÁúÅÁï•ÁöÑ‰∏çÁõ∏ÂÖ≥ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ÊâÄ‰ª• IUnitOfWork ÈáåÈù¢Ëé∑ÂæóÁöÑ ServiceProvider ÊòØ‰∏Ä‰∏™Â≠êÂÆπÂô®„ÄÇ</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">unitOfWork</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IUnitOfWork</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ... ÁúÅÁï•ÁöÑ‰∏çÁõ∏ÂÖ≥ÁöÑ‰ª£Á†Å„ÄÇ</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Â∑•‰ΩúÂçïÂÖÉË¢´ÈáäÊîæÁöÑÂä®‰Ωú„ÄÇ</span>
</span></span><span class="line"><span class="cl">            <span class="n">unitOfWork</span><span class="p">.</span><span class="n">Disposed</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">_ambientUnitOfWork</span><span class="p">.</span><span class="n">SetUnitOfWork</span><span class="p">(</span><span class="n">outerUow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// Â≠êÂÆπÂô®Ë¢´ÈáäÊîæÊó∂ÔºåÈÄöËøáÂ≠êÂÆπÂô®Ëß£ÊûêÁöÑ DbContext ‰πüË¢´ÈáäÊîæ‰∫Ü„ÄÇ</span>
</span></span><span class="line"><span class="cl">                <span class="n">scope</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">unitOfWork</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">scope</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Â∑•‰ΩúÂçïÂÖÉÁöÑ <code>ServiceProvider</code> ÊòØÈÄöËøáÁªßÊâø <code>IServiceProviderAccessor</code> ÂæóÂà∞ÁöÑÔºå‰πüÂ∞±ÊòØËØ¥Âú®ÊûÑÂª∫Â∑•‰ΩúÂçïÂÖÉÁöÑÊó∂ÂÄôÔºåËøô‰∏™ Provider Â∞±ÊòØÂ∑•‰ΩúÂçïÂÖÉÁÆ°ÁêÜÂô®ÂàõÂª∫ÁöÑÂ≠êÂÆπÂô®„ÄÇ</p>
<p>ÈÇ£‰πàÂõûÂà∞‰πãÂâçÁöÑ‰ª£Á†ÅÔºåÊàë‰ª¨ÂæóÁü• DbContext ÊòØÈÄöËøáÂ∑•‰ΩúÂçïÂÖÉÁöÑ <code>ServiceProvider</code> ÂàõÂª∫ÁöÑÔºåÂΩìÂ∑•‰ΩúÂçïÂÖÉË¢´ÈáäÊîæÁöÑÊó∂ÂÄôÔºå‰πü‰ºöËøûÂ∏¶Ëøô‰∏™Â≠êÂÆπÂô®Ë¢´ÈáäÊîæ„ÄÇÈÇ£‰πàÊàë‰ª¨‰πãÂâçËß£ÊûêÂá∫Êù•ÁöÑ DbContext Ôºå‰πüÂ∞±‰ºöÈöèÁùÄÂ≠êÂÆπÂô®ÁöÑÈáäÊîæËÄåË¢´ÈáäÊîæ„ÄÇÂ¶ÇÊûúË¶ÅÈ™åËØÅ‰∏äËø∞ÁåúÊÉ≥ÔºåÂè™ÈúÄË¶ÅÁºñÂÜôÁ±ª‰ºº‰ª£Á†ÅÂç≥ÂèØ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="na">[Fact]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">void</span> <span class="n">TestMethod</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IServiceProvider</span><span class="p">&gt;().</span><span class="n">CreateScope</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IHospitalDbContext</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">scope</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/why-does-abp-vnext-throw-an-exception-if-it-does-not-use-the-unit-of-work/201910100100.gif"
	width="2170"
	height="1080"
	srcset="/p/why-does-abp-vnext-throw-an-exception-if-it-does-not-use-the-unit-of-work/201910100100_huab7e0c5a69abb9bfd232ec18e6b503b4_1478213_480x0_resize_box_1.gif 480w, /p/why-does-abp-vnext-throw-an-exception-if-it-does-not-use-the-unit-of-work/201910100100_huab7e0c5a69abb9bfd232ec18e6b503b4_1478213_1024x0_resize_box_1.gif 1024w"
	loading="lazy"
	
		alt="201910100100"
	
	
		class="gallery-image" 
		data-flex-grow="200"
		data-flex-basis="482px"
	
></p>
<p>Êó¢ÁÑ∂Â¶ÇÊ≠§ÔºåÂ∑•‰ΩúÂçïÂÖÉÊòØ‰ªÄ‰πàÊó∂ÂÄôË¢´ÈáäÊîæÁöÑÂë¢&hellip;Âõ†‰∏∫Êã¶Êà™Âô®ÈªòËÆ§ÊòØ‰∏∫‰ªìÂÇ®Âª∫Á´ã‰∫ÜÊã¶Êà™Âô®ÔºåÊâÄ‰ª•Âú®Ëé∑ÂæóÂà∞ DbContext ÁöÑÊó∂ÂÄôÔºåÊã¶Êà™Âô®Â∑≤ÁªèÂ∞Ü‰πãÂâçÁöÑ DbContext ÈáäÊîæÊéâ‰∫Ü„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Intercept</span><span class="p">(</span><span class="n">IAbpMethodInvocation</span> <span class="n">invocation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(!</span><span class="n">UnitOfWorkHelper</span><span class="p">.</span><span class="n">IsUnitOfWorkMethod</span><span class="p">(</span><span class="n">invocation</span><span class="p">.</span><span class="n">Method</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">unitOfWorkAttribute</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invocation</span><span class="p">.</span><span class="n">Proceed</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊàëÂú®ËøôÈáå...</span>
</span></span><span class="line"><span class="cl">    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">uow</span> <span class="p">=</span> <span class="n">_unitOfWorkManager</span><span class="p">.</span><span class="n">Begin</span><span class="p">(</span><span class="n">CreateOptions</span><span class="p">(</span><span class="n">invocation</span><span class="p">,</span> <span class="n">unitOfWorkAttribute</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invocation</span><span class="p">.</span><span class="n">Proceed</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">uow</span><span class="p">.</span><span class="n">Complete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ë¶ÅÈ™åËØÅ DbContext ÊòØÈöèÂ∑•‰ΩúÂçïÂÖÉ‰∏ÄËµ∑ÈáäÊîæÔºå‰πüÂçÅÂàÜÁÆÄÂçïÔºåÁºñÂÜô‰ª•‰∏ã‰ª£Á†ÅÂç≥ÂèØËøõË°åÊµãËØï„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="na">[Fact]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">void</span> <span class="n">TestMethod</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">rep</span> <span class="p">=</span> <span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IHospitalRepository</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">mgr</span> <span class="p">=</span> <span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IUnitOfWorkManager</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">uow</span> <span class="p">=</span> <span class="n">mgr</span><span class="p">.</span><span class="n">Begin</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">count</span> <span class="p">=</span> <span class="n">rep</span><span class="p">.</span><span class="n">Count</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">uow</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">uow</span><span class="p">.</span><span class="n">Complete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/why-does-abp-vnext-throw-an-exception-if-it-does-not-use-the-unit-of-work/201910100107.gif"
	width="2170"
	height="750"
	srcset="/p/why-does-abp-vnext-throw-an-exception-if-it-does-not-use-the-unit-of-work/201910100107_hue4c1cc2a2d577396a0c31ff2cb83b46e_532526_480x0_resize_box_1.gif 480w, /p/why-does-abp-vnext-throw-an-exception-if-it-does-not-use-the-unit-of-work/201910100107_hue4c1cc2a2d577396a0c31ff2cb83b46e_532526_1024x0_resize_box_1.gif 1024w"
	loading="lazy"
	
		alt="201910100107"
	
	
		class="gallery-image" 
		data-flex-grow="289"
		data-flex-basis="694px"
	
></p>
<h2 id="‰∏âËß£ÂÜ≥">‰∏â„ÄÅËß£ÂÜ≥</h2>
<p>Ëß£ÂÜ≥ÊñπÊ≥ïÂæàÁÆÄÂçïÔºåÂú®ÊúâÁ±ª‰ººÊìç‰ΩúÁöÑÂ§ñÈÉ®ÈÄöËøá <code>[UnitOfWork]</code> ÁâπÊÄßÊàñËÄÖ <code>IUnitOfManager.Begin</code> ÂºÄÂêØ‰∏Ä‰∏™Êñ∞ÁöÑÂ∑•‰ΩúÂçïÂÖÉÂç≥ÂèØ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="na">[Fact]</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">void</span> <span class="n">TestMethod</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">rep</span> <span class="p">=</span> <span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IHospitalRepository</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">var</span> <span class="n">mgr</span> <span class="p">=</span> <span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IUnitOfWorkManager</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">uow</span> <span class="p">=</span> <span class="n">mgr</span><span class="p">.</span><span class="n">Begin</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">count</span> <span class="p">=</span> <span class="n">rep</span><span class="p">.</span><span class="n">Count</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">uow</span><span class="p">.</span><span class="n">Complete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/c#/">C#</a>
        
            <a href="/tags/abp/">ABP</a>
        
            <a href="/tags/abp-vnext/">ABP vNext</a>
        
            <a href="/tags/%E5%B7%A5%E4%BD%9C%E5%8D%95%E5%85%83/">Â∑•‰ΩúÂçïÂÖÉ</a>
        
            <a href="/tags/entity-framework-core/">Entity Framework Core</a>
        
            <a href="/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">ÂºÇÂ∏∏Â§ÑÁêÜ</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Áõ∏ÂÖ≥ÊñáÁ´†</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/abp-vnext-source-code-analysis-integration-of-entityframework-core/">
        
        

        <div class="article-details">
            <h2 class="article-title">Abp vNext Ê∫êÁ†ÅÂàÜÊûê - 14. EntityFramework Core ÁöÑÈõÜÊàê</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/abp-vnext-custom-ef-core-repository-throws-exception/">
        
        

        <div class="article-details">
            <h2 class="article-title">Abp vNext Ëá™ÂÆö‰πâ Ef Core ‰ªìÂÇ®ÂºïÂèëÂºÇÂ∏∏</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/abp-vnext-source-code-analysis---4-unit-of-work/">
        
        

        <div class="article-details">
            <h2 class="article-title">Abp vNext Ê∫êÁ†ÅÂàÜÊûê - 4. Â∑•‰ΩúÂçïÂÖÉ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/abp-vnext-source-code-analysis---20-email-and-sms-support/">
        
        

        <div class="article-details">
            <h2 class="article-title">Abp vNext Ê∫êÁ†ÅÂàÜÊûê - 20. ÁîµÂ≠êÈÇÆ‰ª∂‰∏éÁü≠‰ø°ÊîØÊåÅ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/abp-vnext-source-code-analysis---19-unit-testing/">
        
        

        <div class="article-details">
            <h2 class="article-title">Abp vNext Ê∫êÁ†ÅÂàÜÊûê - 19. ÂçïÂÖÉÊµãËØï</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="real-zony/real-zony.github.io"
    data-repo-id="R_kgDOIC_OeA"
    data-category="General"
    data-category-id="DIC_kwDOIC_OeM4CRp3M"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="en"
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('preferred_color_scheme');
            } else {
                setGiscusTheme('preferred_color_scheme');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Zony ÁöÑÂçöÂÆ¢
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#‰∏ÄÈóÆÈ¢ò">‰∏Ä„ÄÅÈóÆÈ¢ò</a></li>
    <li><a href="#‰∫åÂéüÂõ†">‰∫å„ÄÅÂéüÂõ†</a>
      <ol>
        <li><a href="#21-‰∏∫‰ªÄ‰πàËÉΩÂ§üË∞ÉÁî®-linq-Êâ©Â±ï">2.1 ‰∏∫‰ªÄ‰πàËÉΩÂ§üË∞ÉÁî® LINQ Êâ©Â±ï?</a></li>
        <li><a href="#22-iqueryable-‰ΩøÁî®ÁöÑ-dbcontext">2.2 IQueryable ‰ΩøÁî®ÁöÑ DbContext</a></li>
        <li><a href="#23-dbcontext-ÂíåÂ∑•‰ΩúÂçïÂÖÉÁöÑÈîÄÊØÅ">2.3 DbContext ÂíåÂ∑•‰ΩúÂçïÂÖÉÁöÑÈîÄÊØÅ</a></li>
      </ol>
    </li>
    <li><a href="#‰∏âËß£ÂÜ≥">‰∏â„ÄÅËß£ÂÜ≥</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
